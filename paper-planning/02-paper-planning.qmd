---
title: "Paper planning for paper 3"
format:
    html:
        code-fold: true
        code-summary: "Show the code"
        code-tools: true
        theme: minty
---

```{r, include=F}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F)

```


## Purpose

Planning for the third paper regressions.

## Abstract

What are the effects of technological change on local labour markets? In this paper we seek to answer this question, leveraging a plausibly exogenous technology shock - the connection of the Western Line of the electricity grid between two hydropower stations in Sweden - that provided rural, otherwise unremarkable, parishes a stable and high-quality electricity connection prior to their neighbours. We motivate the exogeneity of this shock by documenting the geographic rollout of the grid through the first half of the 20th century and comparing attributes of the electrified parishes with a control group of parishes, prior to electrification.

We measure two individual-level outcomes nine years after the shock - migration status and income - with Swedish census data from 1930. We use a cross-section of individuals to measure the effect of electrification on the propensity to migrate and on earnings in the new parish for six distinct groups: the combination of a binary indicator for being born in an electricity parish (receiving the treatment) or not, an indicator for living in an electricity parish in 1930 or not, and an indicator for living in your parish of birth or not. Controls include geographic fixed effects, age, gender, and a HISCLASS grouping proxying social class.

Initial findings point to higher levels of migration in electricity parishes than in non-electricity parishes, particularly for prime working-age adults. We find a higher level of income for all individuals who no longer live in their parish of birth, indicating a wage premium for migration. In addition, we find that among those born in electricity parishes, the individuals who left their parish of birth and moved beyond the borders of an electricity parish saw the highest levels of income, on average, of our six groups. This indicates that the shock of electrification lowered the barriers to migration (should we speculate about this?) for individuals receiving the treatment of electrification.

## Intro

So far we just want to show the simple things. What has happened for the people who were born in electricity parishes, and then migrate?


```{r}

library(tidyverse)
setwd(here::here())

df <- read_rds("data/augmented/df_1930_augmented.rds")

df <- df %>% 
  filter(tce_group_250 %in% c("control", "treatment"),
         adult_1930 == "Adult")

theme_set(theme_light())
```

```{r}
library(ggridges)

df %>% 
  filter(!is.na(hisclass_group_abb),
         !is.na(inkomst)) %>% 
  mutate(log_income = log(inkomst + 1),
         hisclass_group_abb = fct_reorder(hisclass_group_abb, hisclass_code_abb)) %>% 
  ggplot(aes(x = log_income, y = hisclass_group_abb, fill = hisclass_group_abb)) +
  geom_density_ridges2(show.legend = F) +
  scale_x_continuous(limits = c(4, 12))

df <- df %>% 
  mutate(log_income = log(inkomst + 1),
         log_wealth = log(formogh + 1))

# code up schooling
df <- df %>%
  mutate(schooling = case_when(
    skola == "" ~ NA_character_,
    skola == "0" ~ "No school, no information about ability to read or write",
    skola == "1" ~ "No school, able to read and write",
    skola == "2" ~ "Can read but can’t write",
    skola == "3" ~ "Primary school",
    skola == "4" ~ "Additional course after primary school",
    skola == "5" ~ "Secondary school without high school exam",
    skola == "7|6" ~ "High school exam without exam from higher educational institution",
    skola == "8" ~ "Exam from higher educational institution, but not from a university",
    skola == "9" ~ "University",
    skola == "x|X" ~ "No school, no information about ability to read or write",
    skola == "y|Y" ~ "No school, able to read and write",
    TRUE ~ NA_character_
  )) %>%
  mutate(schooling_abb = case_when(
    schooling == "No school, no information about ability to read or write" ~ NA_character_,
    schooling %in% c("Can read but can’t write", "No school, able to read and write") ~ "Literate",
    schooling %in% c("Primary school") ~ "Primary school",
    schooling %in% c("Secondary school without high school exam", "Additional course after primary school") ~ "Post primary schooling",
    schooling %in% c("University", "Exam from higher educational institution, but not from a university") ~ "Post-secondary and university",
    TRUE ~ NA_character_
  ))

# fixing hushållerska 
df <- df %>%
  mutate(hisclass_group_abb = as.character(hisclass_group_abb)) %>% 
  mutate(hisclass_group_abb = case_when(
    hisco_code %in% c(22490, 54020) ~ "Low-skilled workers",
    TRUE ~ hisclass_group_abb
  )) %>% 
  mutate(hisclass_group_abb = factor(hisclass_group_abb))


df_reg <- df 
```


## Who is in the treatment group?

We have the six groups we are interested in:

If you are born in an electricity parish and still live in your parish of birth.

If you are born in an electricity parish and you moved to a new electricity parish

If you are born in an electricity parish and you moved to a new non-electricity parish.

Born outside electricity parish and still live in parish of birth.

Born outside electricity parish and moved to electricity parish.

Born outside electricity parish and move to non-electricity parish.

### What proportion of the sample is each group?

The table shows that the smallest group are those who moved within the electricity parishes.

The largest group are those who were born outside electricity parishes and moved to another non-electricity parish.

```{r}
library(gt)

df_reg %>%
  filter(!is.na(lives_in_parish_of_birth)) %>%
  group_by(
    lives_in_parish_of_birth,
    electricity_parish_born,
    electricity_parish_living_in
  ) %>%
  summarise(
    n = n(),
    mean_income = mean(inkomst, na.rm = T)
  ) %>%
  ungroup() %>%
  mutate(
    lives_in_parish_of_birth = case_when(
      lives_in_parish_of_birth == 1 ~ "Lives in parish of birth",
      TRUE ~ "Lives outside parish of birth"
    ),
    electricity_parish_born = ifelse(electricity_parish_born == 1,
      "Born in electricity parish",
      "Born outside electricity parish"
    ),
    electricity_parish_living_in = ifelse(electricity_parish_living_in == 1,
      "Lives in electricity parish",
      "Lives outside electricity parish"
    )
  ) %>%
  mutate(label = str_c(lives_in_parish_of_birth, " and ", electricity_parish_born, " and ", electricity_parish_living_in)) %>%
  mutate(pct_share = n / sum(n)) %>%
  select(label, n, pct_share, mean_income) %>%
  arrange(n) %>%
  gt() %>%
  fmt_number(decimals = 0, columns = n) %>%
  fmt_percent(decimals = 2, columns = pct_share) %>%
  fmt_currency(columns = mean_income, currency = "SEK", decimals = 0) %>%
  cols_label(
    label = "",
    n = "Number in sample",
    pct_share = "Percentage of sample",
    mean_income = "Mean income"
  ) %>%
  tab_header(
    title = md("Sample makeup"),
    subtitle = md("By place of birth and place of habitation in 1930")
  )


```

HISCO classifications for those who were born in electricity parishes and moved

```{r}
df_movers_out <- df %>%
  filter(
    electricity_parish_born == 1,
    electricity_parish_living_in == 0
  ) %>%
  count(hisclass_group_abb) %>%
  filter(!is.na(hisclass_group_abb)) %>%
  mutate(group = "Movers out of electricity parishes")

df_movers_in <- df %>%
  filter(
    electricity_parish_born == 0,
    electricity_parish_living_in == 1
  ) %>%
  count(hisclass_group_abb) %>%
  filter(!is.na(hisclass_group_abb)) %>%
  mutate(group = "Movers into of electricity parishes")
```

## Who has the steepest age gradient in income

```{r}
#| column: page

library(geomtextpath)

order <- df_reg %>%
  filter(!is.na(hisclass_group_abb)) %>% 
  # slice_sample(n = 10000, weight_by = hisclass_group_abb) %>% 
  ggplot(aes(age, inkomst, colour = hisclass_group_abb)) +
  # geom_point(alpha = .5) +
	geom_labelsmooth(aes(label = hisclass_group_abb), se = F, alpha = .7, cex = 8) +
  scale_x_continuous(limits = c(NA, 90)) +
  scale_y_log10(labels = scales::number_format()) +
  theme(legend.position = "none") +
  labs(x = "Age in years",
       y = "Income in SEK (log scale)")

order
```

Now I want to see when the downturn happens?

```{r}
#| column: page

df_reg %>%
  filter(!is.na(hisclass_group_abb)) %>%
  group_by(hisclass_group_abb, age) %>%
  summarise(mean_income = mean(inkomst, na.rm = T)) %>%
  ggplot(aes(age, mean_income, colour = hisclass_group_abb)) +
  geom_point() +
  geom_smooth(se = F) +
  scale_x_continuous(limits = c(NA, 90))
```

I have a problem. Unskilled workers earn more than skilled workers until age 60. Why?

Let's check what the most common occupations are within each group? Maybe the skilled workers are categorised wrong?

```{r}
#| column: page

library(tidytext)

df_reg %>% 
  filter(!is.na(hisclass_group_abb)) %>% 
  group_by(hisclass_group_abb) %>% 
  count(yrke.y) %>% 
  slice_max(n, n = 12) %>% 
  ungroup() %>% 
  mutate(yrke.y = reorder_within(yrke.y, n, hisclass_group_abb)) %>% 
  ggplot(aes(n, yrke.y, fill = hisclass_group_abb)) +
  geom_col(show.legend = F) +
  facet_wrap(~ hisclass_group_abb, scales = "free_y") +
  scale_y_reordered()
```

So there are some problems to fix.

They are: 

Arbetare is not elite. Fixed this by recoding hisco 99900 as 11 not -1. I think it was a typo from the translation between spss and R. 

Hushållerska and hushåll and hushållshjälp are coded to 22490. They are not supervisors.
22420 - housekeeper is not a supervisor.



## What is the occupational group breakdown for two groups of interest?

We can see that the groups are largely similar, and that those who moved out of electricity parishes had slightly more lower middle class and elites than those who moved into electricity parishes.

```{r}
#| column: page

df_movers_out %>%
  bind_rows(df_movers_in) %>%
  ggplot(aes(x = group, y = n, fill = hisclass_group_abb)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = NULL,
    y = "Share of inhabitants",
    fill = "Occupational group"
  )
```


```{r}
df_movers_out <- df %>%
  filter(
    electricity_parish_born == 1,
    electricity_parish_living_in == 0
  ) %>%
  mutate(group = "Movers out of electricity parishes")

df_movers_in <- df %>%
  filter(
    electricity_parish_born == 0,
    electricity_parish_living_in == 1
  ) %>%
  mutate(group = "Movers into electricity parishes")

df_stayers_in <- df %>%
  filter(
    electricity_parish_born == 1,
    electricity_parish_living_in == 1
  ) %>%
  mutate(group = "Stayers in electricity parishes")

df_stayers_out <- df %>%
  filter(
    electricity_parish_born == 0,
    electricity_parish_living_in == 0
  ) %>%
  mutate(group = "Stayers in other parishes")


df_plot <- df_movers_out %>% 
  bind_rows(df_movers_in) %>% 
  bind_rows(df_stayers_in) %>% 
  bind_rows(df_stayers_out)
```

## Income distributions by migrant status and occupational group

When comparing the distributions of income by migrant status and occupational groups we can see that your occupational group has a higher correlation with income than your migratory status. It is also possible to see that movers have on average higher median incomes than stayers. Further, we see that among stayers in the top of the income distribution (elites and lower middle class) other parishes have higher incomes than electricity parishes, but that this is reversed at the bottom of the income distrbution (skilled workers and unskilled and farm workers). 

```{r}
#| column: page
#| fig-height: 10

df_plot %>%
  filter(!is.na(hisclass_group_abb)) %>%
  ggplot(aes(log(inkomst + 1), fill = group)) +
  geom_boxplot(alpha = .9, outlier.alpha = .1) +
  facet_wrap(~hisclass_group_abb, nrow = 7) +
  scale_fill_brewer(palette = "Paired",
                    guide = guide_legend(reverse = TRUE)) +
  scale_x_continuous(limits = c(4, NA)) +
  labs(
    x = "Log income",
    fill = "Group",
    title = "Distribution of income by migratory status and occupational group"
  )
```

Try again with density ridges

```{r}
#| column: page
#| fig-height: 10

df_plot %>%
  filter(!is.na(hisclass_group_abb)) %>%
  ggplot(aes(x = log(inkomst + 1), y = group, fill = group)) +
  stat_density_ridges(quantile_lines = TRUE, quantiles = 2) +
  facet_wrap(~hisclass_group_abb, ncol = 2) +
  scale_fill_brewer(palette = "Paired") +
  scale_x_continuous(limits = c(4, NA)) +
  theme(legend.position = "none") +
  labs(
    x = "Log income",
    fill = "Group",
    title = "Distribution of income by migratory status and occupational group"
  )
```

```{r}
#| column: page
#| fig-height: 10

df_plot %>% 
  filter(!is.na(hisclass_group_abb)) %>%
  ggplot(aes(x = log(inkomst + 1), y = group, fill = group)) +
  stat_density_ridges(quantile_lines = TRUE, quantiles = 2) +
  # facet_wrap(~hisclass_group_abb, nrow = 7) +
  scale_fill_brewer(palette = "Paired") +
  scale_x_continuous(limits = c(4, NA)) +
  theme(legend.position = "none") +
  labs(
    x = "Log income",
    fill = "Group",
    title = "Distribution of income by migratory status and occupational group"
  )
```

Skill distributions

```{r}
#| column: page

df_reg <- df_reg %>%
  mutate(
    hisco_code_char = as.character(hisco_code),
    hisco_code_start = case_when(
      nchar(hisco_code_char) < 4 ~ NA_real_,
      nchar(hisco_code_char) == 4 ~ 0,
      TRUE ~ as.numeric(str_extract(hisco_code_char, "^[0-9]"))
    ),
    hisco_major_group_code = case_when(
      hisco_code_start %in% c(0, 1) ~ 1,
      hisco_code_start %in% c(7, 8, 9) ~ 7,
      TRUE ~ hisco_code_start
    )
  ) %>%
  select(-hisco_code_char, -hisco_code_start) %>%
  mutate(hisco_major_group_name = case_when(
    hisco_major_group_code == 1 ~ "PROFESSIONAL, TECHNICAL AND RELATED WORKERS",
    hisco_major_group_code == 2 ~ "ADMINISTRATIVE AND MANAGERIAL WORKERS",
    hisco_major_group_code == 3 ~ "CLERICAL AND RELATED WORKERS",
    hisco_major_group_code == 4 ~ "SALES WORKERS",
    hisco_major_group_code == 5 ~ "SERVICE WORKERS",
    hisco_major_group_code == 6 ~ "AGRICULTURAL, ANIMAL HUSBANDRY AND FORESTRY WORKERS, FISHERMEN AND HUNTERS",
    hisco_major_group_code == 7 ~ "PRODUCTION AND RELATED WORKERS, TRANSPORT EQUIPMENT OPERATORS AND LABOURERS",
  )) %>%
  mutate(
    hisco_major_group_name = str_to_sentence(hisco_major_group_name),
    hisco_major_group_name = fct_reorder(hisco_major_group_name, hisco_major_group_code)
  )


df_reg %>% 
  filter(!is.na(hisco_major_group_name)) %>% 
  ggplot(aes(x = log_income, y = hisco_major_group_name, fill = hisco_major_group_name)) +
  stat_density_ridges(quantile_lines = TRUE, quantiles = 2) +
  scale_fill_brewer(palette = "Paired") +
  scale_x_continuous(limits = c(4, NA)) +
  theme(legend.position = "none") +
  labs(x = "Log income",
       y = NULL,
       title = "Income distribution by HISCO major group")
```

Skill distribution density kernels

```{r}
#| column: page

df_reg <- df_reg %>%
  mutate(situation_group = case_when(
    electricity_parish_born == 1 & electricity_parish_living_in == 0 ~ "Movers out of electricity parishes",
    electricity_parish_born == 0 & electricity_parish_living_in == 1 ~ "Movers into electricity parishes",
    electricity_parish_born == 1 & electricity_parish_living_in == 1 ~ "Stayers in electricity parishes",
    electricity_parish_born == 0 & electricity_parish_living_in == 0 ~ "Stayers in other parishes"
  ))


df_reg %>% 
  ggplot(aes(hisco_major_group_code, y = situation_group, fill = situation_group)) +
  stat_density_ridges(quantile_lines = TRUE, quantiles = 2) +
  theme(legend.position = "none")
```


```{r}
#| column: page

df_reg %>%
  group_by(situation_group) %>%
  count(hisco_major_group_code) %>%
  ggplot(aes(hisco_major_group_code, y = n, fill = situation_group)) +
  geom_col() +
  facet_wrap(~ situation_group, nrow = 4, scales = "free_y") +
  theme(legend.position = "none") +
  scale_x_continuous(labels = scales::number_format(), breaks = c(1:7)) +
  labs(x = "HISCO major group (1 is highest)",
       y = "Number of individuals")
```


```{r}
#| column: page

df_reg %>%
  group_by(situation_group) %>%
  count(hisco_major_group_code) %>%
  mutate(pct_share = n / sum(n)) %>%
  ungroup() %>%
  ggplot(aes(factor(hisco_major_group_code), y = pct_share, fill = situation_group)) +
  geom_col(position = "dodge") +
  theme(legend.position = "right") +
  scale_fill_brewer(palette = "Paired") +
  scale_x_discrete(breaks = c(1:7)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "HISCO major group (1 is highest)",
    y = "Number of individuals",
    fill = NULL
  )
```

```{r}
#| column: page

df_reg %>%
  filter(!is.na(hisco_major_group_name)) %>% 
  group_by(situation_group) %>%
  count(hisco_major_group_name) %>%
  mutate(pct_share = n / sum(n),
         pct_share_lab = scales::percent(pct_share)) %>%
  ungroup() %>%
  ggplot(aes(y =factor(hisco_major_group_name), x = pct_share, fill = situation_group, label = pct_share_lab)) +
  geom_col(position = "dodge") +
  geom_label(position = position_dodge(width = 0.9), hjust = -.1, show.legend = F) +
  theme(legend.position = "bottom") +
  scale_fill_brewer(palette = "Paired") +
  scale_y_discrete() +
  scale_x_continuous(labels = scales::percent_format()) +
  labs(
    x = "HISCO major group (1 is highest)",
    y = "Number of individuals",
    fill = NULL
  )
```


## Regressions

So let us see if this is the case once we control for some more factors, through regression analysis.

In addition we want to check whether the trimming of the sample based on age has an effect.

### Is there a return to migration in terms of income?

To answer this question we have to look at the both the evidence on average and at the margin.

First we use a linear regression to assess if living in your parish of birth has an impact on your income in 1930, controlling for occupational group, age, and gender.

The regression output below shows that the living in your parish of birth is associated with a decrease in income of 367 kronor, significant at the one percent level. In terms of magnitude, this is about 43% of the gender wage gap, and or 37% of the median income (1000kr). The effect is large in magnitude, indicating that there is probably a selection effect such that those who leave their parish of birth do so in part because they expect to find higher returns to their skills in a geographically different labour market.

```{r}
library(fixest)
library(gtsummary)
library(gt)

df_reg <- df_reg %>% 
  mutate(hisclass_group_abb = fct_relevel(hisclass_group_abb, "Farmers and fishermen"),
         age_2 = age^2,
         log_income = log(inkomst + 1))

reg_out <- feols(log_income ~ lives_in_parish_of_birth + hisclass_group_abb + schooling_abb + age + age_2 + female, data = df_reg)

reg_out %>%
  gtsummary::tbl_regression() %>%
  add_significance_stars() %>%
  add_n()
```

### Baseline effect of electricity parish

Yay! You get a higher income for being born in electricity parish and living in one now. Sig at one percent and large in magnitude. Stayers lose out less.

```{r}
reg_out <- feols(log_income ~ lives_in_parish_of_birth*electricity_parish_living_in + hisclass_group_abb + schooling_abb + age + age_2 + female, data = df_reg)

reg_out %>%
  gtsummary::tbl_regression() %>%
  add_significance_stars() %>%
  add_n()
```

### Try adding in parish fixed effects?

```{r}
reg_out <- feols(log_income ~ lives_in_parish_of_birth*electricity_parish_living_in + hisclass_group_abb + schooling_abb + age + age_2 + female | scbkod, data = df_reg)

reg_out %>%
  gtsummary::tbl_regression() %>%
  add_significance_stars() %>%
  add_n()
```

This throws out living in and electricity parish for collinearity `The variable 'electricity_parish_living_in' has been removed because of collinearity (see $collin.var).`

In the second regression we look at the effect of the distance between your parish of birth and your parish of inhabitance in 1930, in kilometers. The coefficient is positive at 1.3, and is significant at the 1 percent level. This indicates a positive return to migration.

We don't see a significant interaction effect between distance from birth parish to current parish.

```{r}
reg_out <- feols(log_income ~ dist_bp_to_cp_km*electricity_parish_living_in + hisclass_group_abb + schooling_abb + age + age_2 + female, data = df_reg)

reg_out %>% gtsummary::tbl_regression() %>% 
  add_significance_stars() %>% 
  add_n()
```


```{r}
df_magnitude <- df_reg %>%
  summarise(
    mean_dist_bp_to_cp_km = mean(dist_bp_to_cp_km, na.rm = T),
    median_dist_bp_to_cp_km = median(dist_bp_to_cp_km, na.rm = T),
    median_income = median(inkomst, na.rm = T)
  )

estimate <- reg_out %>% 
  broom::tidy() %>% 
  filter(term == "dist_bp_to_cp_km") %>% 
  pull(estimate)

```

To determine the effect at the median and mean distances of migration, we multiply this coefficient by 112 km (the mean) and 25 km (the median), and divide the effect by the median income to interpret the effect as a percentage of the median income. This is shown as a positive return of 11 percent of the median income at the mean distance of migration from birth parish, and 2.6 percent at the median migration distance of 25km. 

```{r}
#| column: page

df_magnitude %>%
  pivot_longer(-median_income) %>%
  mutate(
    estimate = estimate,
    effect_kr = value * estimate,
    effect_as_pct_median_income = effect_kr / median_income
  ) %>%
  select(name, effect_kr, effect_as_pct_median_income) %>%
  gt::gt() %>%
  fmt_percent(columns = effect_as_pct_median_income) %>%
  fmt_currency(columns = effect_kr, decimals = 0, currency = "SEK")


```


## Places of migration for the different people born in different places

What is the distribution of migration distance by parish of birth and occupational grouping?

```{r}
#| column: page
#| fig-height: 10

df_reg %>%
  filter(!is.na(hisclass_group_abb)) %>%
  ggplot(aes(dist_bp_to_cp_km, fill = factor(electricity_parish_born))) +
  geom_density(alpha = .5) +
  scale_x_log10() +
  labs(
    x = "Distance from birth parish to current parish (km)",
    fill = "Born in electricity parish"
  ) +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~hisclass_group_abb, nrow = 7) +
  theme(legend.position = "right")
```

### What does this look like by group at the mean and median?

So it seems as if those born outside electricity parishes migrate further, on average and at the median.

```{r}
#| column: page

df_reg %>%
  filter(!is.na(hisclass_group_abb)) %>%
  group_by(
    electricity_parish_born,
    hisclass_group_abb
  ) %>%
  summarise(
    mean_dist_bp_to_cp_km = mean(dist_bp_to_cp_km, na.rm = T),
    median_dist_bp_to_cp_km = median(dist_bp_to_cp_km, na.rm = T)
  ) %>%
  ungroup() %>%
  pivot_wider(names_from = electricity_parish_born, values_from = c("mean_dist_bp_to_cp_km", "median_dist_bp_to_cp_km")) %>%
    gt::gt() %>%
    fmt_number(decimals = 2, columns = -hisclass_group_abb) %>%
    cols_label(
      hisclass_group_abb = "",
      mean_dist_bp_to_cp_km_0 = "Outside Electricity Parish",
      mean_dist_bp_to_cp_km_1 = "Inside Electricity Parish",
      median_dist_bp_to_cp_km_0 = "Outside Electricity Parish",
      median_dist_bp_to_cp_km_1 = "Inside Electricity Parish"
    ) %>%
    tab_spanner(
      label = "Mean distance",
      columns = c(
        mean_dist_bp_to_cp_km_0, mean_dist_bp_to_cp_km_1
      )
    ) %>%
    tab_spanner(
      label = "Median distance",
      columns = c(
        median_dist_bp_to_cp_km_0, median_dist_bp_to_cp_km_1
      )
    ) %>%
    tab_header(
      title = md("Distances of migration"),
      subtitle = md("By place of birth and occupational class")
    )
  
```

### Regression of distance of migration by place of birth

```{r}
reg_out <- lm(dist_bp_to_cp_km ~ electricity_parish_born + hisclass_group_abb + age + female, data = df_reg)

reg_out_2 <- lm(dist_pp_to_cp_km ~ electricity_parish_born + hisclass_group_abb + age + female, data = df_reg)

reg_out <- reg_out %>%
  gtsummary::tbl_regression() %>%
  add_significance_stars() %>%
  add_n()

reg_out_2 <- reg_out_2 %>% 
    gtsummary::tbl_regression() %>%
  add_significance_stars() %>%
  add_n()

tbl_merge(tbls = list(reg_out, reg_out_2))

```

Do people born in electricity parishes see a higher return to migration the same distance?

So we want to run a regression where income is dep var, and indepvar of interest is electricity_parish_born

```{r}
reg_out <- lm(log_income ~ electricity_parish_born + dist_bp_to_cp_km + hisclass_group_abb + age + female, data = df_reg)

reg_out %>%
  gtsummary::tbl_regression() %>%
  add_significance_stars() %>%
  add_n()
```

## Transitions

```{r}

df_reg <- df_reg %>% 
  mutate(hisclass_group_abb = fct_reorder(hisclass_group_abb, hisclass_code_abb))


df_reg_25 <- df_reg %>%
  # we need only the id and occupation variables
  select(id, yrke = yrke25) %>% 
  mutate(
    # this makes a copy of the original column, that we then modify
    yrke_copy = yrke,
    yrke = str_to_lower(yrke),
    # We create a column for former, indicated by fd. We remove this from the original column.
    # we can use this later to improve the hisclass classification

    flag_fd = ifelse(str_detect(yrke, "f\\.d\\.|f\\.d|^fd| fd|f d\\.| f\\. d\\.|f\\. d$"),TRUE, FALSE),
    yrke = str_remove_all(yrke, "f\\.d\\.|f\\.d|^fd| fd|f d\\.| f\\. d\\.|f\\. d$"),
    # flag for only doing the occupation temporarily
    flag_fn = ifelse(str_detect(yrke, "f\\.n\\.|f\\. n\\.|f\\. n"),TRUE, FALSE),
    yrke = str_remove_all(yrke, "f\\.n\\.|f\\. n\\.|f\\. n"),

    # create a column for place of work
    yrke_pow = str_extract(yrke, " hos .*| vid .*| i .*| på.*| å .*| h\\. "),
    yrke = str_remove_all(yrke, " hos .*| vid .*| i .*| på.*| å .*| h\\. "),

    # create a column for former occupation
    yrke_f_occ = str_extract(yrke, " f\\..*"),
    
    # tidy up the remaining occpations
    yrke = str_remove_all(yrke, " f\\..*"),
    yrke = str_remove_all(yrke, " fa da"),
    yrke = str_remove_all(yrke, "^fa | fa$| fa "),
    yrke = str_remove_all(yrke, "^fada | fada$| fada "),
    yrke = str_remove_all(yrke, "^da | da$| da ")
  ) %>%
  mutate(flag_for_multi_occs = ifelse(str_detect(yrke_copy, "f\\.d\\.$|f\\.d$|^fd$| fd$|f d\\.$| f\\. d\\.$|f\\. d$| f\\.$"
      ) &
        str_detect(yrke_copy, " [A-Z].*"), yes = TRUE, no = FALSE
    )
  ) %>%
  mutate(
    yrke_clean = str_squish(str_remove(yrke, "f\\.d\\.$|f\\.d$|^fd$| fd$|f d\\.$| f\\. d\\.$|f\\. d$| f\\.$")),
    yrke_f_occ = case_when(
      flag_for_multi_occs == TRUE ~ word(yrke_clean, -1),
      TRUE ~ NA_character_
    ),
    yrke = case_when(
      flag_for_multi_occs == TRUE ~ str_remove(yrke, " .*"),
      TRUE ~ yrke
    )
  ) %>%
  select(-yrke_clean) %>% 
  mutate(
    # remove numbers that begin a word
    yrke = str_remove_all(yrke, "[0-9]."),
    yrke = str_remove_all(yrke, "[:punct:]"),
    yrke = str_to_lower(yrke),
    yrke = str_squish(yrke)
  ) %>%
  # tidy up funny letters
  mutate(yrke_1 = word(yrke, 1))

df_reg_25 <- df_reg_25 %>% 
  select(id, yrke_25 = yrke) 

lookup <- df_reg %>% 
  select(yrke = yrke.y, hisclass_group_abb) %>% 
  distinct()

df_reg_25 <- df_reg_25 %>% 
  left_join(lookup, by = c("yrke_25" = "yrke")) %>% 
  rename(hisclass_group_abb_25 = hisclass_group_abb)

transitions_25_30 = df_reg %>% 
  select(id, hisclass_group_abb, electricity_parish_living_in, electricity_parish_born) %>% 
  inner_join(df_reg_25, by = "id")
```

What do the transitions in terms of hisclass look like between 1925 and 1930?

```{r}
#| column: page

cols <- paletteer::paletteer_d("ggsci::blue_material", n = 10) %>%
  as.character() %>% paste0() 

transitions_25_30 %>%
  count(hisclass_group_abb_25, hisclass_group_abb) %>%
  filter(
    !is.na(hisclass_group_abb_25),
    !is.na(hisclass_group_abb)
  ) %>%
  pivot_wider(names_from = hisclass_group_abb, values_from = n) %>%
  gt() %>%
  data_color(
    columns = -hisclass_group_abb_25,
    colors  = scales::col_numeric(
      palette = cols,
      domain = NULL
    )
  ) %>% 
  tab_spanner(columns = Elite:`Unskilled workers`, label = "HISCLASS in 1930") %>% 
  cols_label(hisclass_group_abb_25 = "HISCLASS in 1925") %>% 
  tab_header(title = "Transition matrix",
             subtitle = "Between 1925 and 1930 - raw numbers") %>% 
  cols_align(hisclass_group_abb_25, align = "left")
```

Or by percentage share

```{r}
#| column: page

transitions_25_30 %>%
  count(hisclass_group_abb_25, hisclass_group_abb) %>%
  filter(
    !is.na(hisclass_group_abb_25),
    !is.na(hisclass_group_abb)
  ) %>%
  group_by(hisclass_group_abb_25) %>%
  mutate(pct_share = n / sum(n)) %>%
  ungroup() %>%
  select(-n) %>%
  pivot_wider(names_from = hisclass_group_abb, values_from = pct_share) %>%
  gt() %>%
  data_color(
    columns = -hisclass_group_abb_25,
    colors = scales::col_numeric(
      palette = cols,
      domain = NULL
    )
  ) %>%
  tab_spanner(columns = Elite:`Unskilled workers`, label = "HISCLASS in 1930") %>%
  cols_label(hisclass_group_abb_25 = "HISCLASS in 1925") %>%
  fmt_percent(columns = -hisclass_group_abb_25) %>% 
  tab_header(title = "Transition matrix",
             subtitle = "Between 1925 and 1930 - percentage of HISCLASS in 1925")  %>% 
  cols_align(hisclass_group_abb_25, align = "left")


```

Now try to distinguish between groups

```{r}
#| column: page

cols <- paletteer::paletteer_d("ggsci::red_material", n = 10) %>%
  as.character() %>% paste0() 

transitions_25_30 %>%
  count(hisclass_group_abb_25, hisclass_group_abb, electricity_parish_born) %>%
  filter(
    !is.na(hisclass_group_abb_25),
    !is.na(hisclass_group_abb)
  ) %>%
  pivot_wider(names_from = hisclass_group_abb, values_from = n) %>%
  mutate(electricity_parish_born = case_when(
    electricity_parish_born == 0 ~ "Born outside electricity parish",
    TRUE ~ "Born in electricity parish"
  )) %>% 
  group_by(electricity_parish_born) %>% 
  gt() %>%
  data_color(
    columns = -hisclass_group_abb_25,
    colors  = scales::col_numeric(
      palette = cols,
      domain = NULL
    )
  ) %>% 
  tab_spanner(columns = Elite:`Unskilled workers`, label = "HISCLASS in 1930") %>% 
  cols_label(hisclass_group_abb_25 = "HISCLASS in 1925") %>% 
  tab_header(title = "Transition matrix by type of birth parish",
             subtitle = "Between 1925 and 1930 - raw numbers")  %>% 
  cols_align(hisclass_group_abb_25, align = "left")
```

Or in pct terms

```{r}
#| column: page

cols <- paletteer::paletteer_d("ggsci::green_material", n = 10) %>%
  as.character() %>% paste0() 

transitions_25_30 %>%
  count(hisclass_group_abb_25, hisclass_group_abb, electricity_parish_living_in) %>%
  filter(
    !is.na(hisclass_group_abb_25),
    !is.na(hisclass_group_abb)
  ) %>%
  group_by(hisclass_group_abb_25, electricity_parish_living_in) %>% 
  mutate(pct_share = n / sum(n)) %>% 
  ungroup() %>% 
  select(-n) %>% 
  pivot_wider(names_from = hisclass_group_abb, values_from = pct_share) %>%
  mutate(electricity_parish_living_in = case_when(
    electricity_parish_living_in == 0 ~ "Living outside electricity parish",
    TRUE ~ "Living in electricity parish"
  )) %>% 
  group_by(electricity_parish_living_in) %>% 
  gt() %>%
  data_color(
    columns = -hisclass_group_abb_25,
    colors  = scales::col_numeric(
      palette = cols,
      domain = NULL
    )
  ) %>% 
  tab_spanner(columns = Elite:`Unskilled workers`, label = "HISCLASS in 1930") %>% 
  cols_label(hisclass_group_abb_25 = "HISCLASS in 1925") %>% 
  fmt_percent(columns = -hisclass_group_abb_25) %>% 
  tab_header(title = "Transition matrix by type of birth parish",
             subtitle = "Between 1925 and 1930 - percentage of HISCLASS in 1925")  %>% 
  cols_align(hisclass_group_abb_25, align = "left")
```


```{r}
#| column: page

transitions_25_30 %>%
  count(hisclass_group_abb_25, hisclass_group_abb, electricity_parish_born) %>%
  filter(
    !is.na(hisclass_group_abb_25),
    !is.na(hisclass_group_abb)
  ) %>%
  group_by(hisclass_group_abb_25, electricity_parish_born) %>% 
  mutate(pct_share = n / sum(n)) %>% 
  ungroup() %>% 
  select(-n) %>% 
  pivot_wider(names_from = hisclass_group_abb, values_from = pct_share) %>%
  mutate(electricity_parish_born = case_when(
    electricity_parish_born == 0 ~ "Born outside electricity parish",
    TRUE ~ "Born in electricity parish"
  )) %>% 
  group_by(electricity_parish_born) %>% 
  gt() %>%
  data_color(
    columns = -hisclass_group_abb_25,
    colors  = scales::col_numeric(
      palette = cols,
      domain = NULL
    )
  ) %>% 
  tab_spanner(columns = Elite:`Unskilled workers`, label = "HISCLASS in 1930") %>% 
  cols_label(hisclass_group_abb_25 = "HISCLASS in 1925") %>% 
  fmt_percent(columns = -hisclass_group_abb_25) %>% 
  tab_header(title = "Transition matrix by type of birth parish",
             subtitle = "Between 1925 and 1930 - percentage of HISCLASS in 1925")  %>% 
  cols_align(hisclass_group_abb_25, align = "left")
```

## Transitions by hisco main group

Now we are looking at transitions by occupational group rather than HISCLASS.

```{r}
df_reg_25 <- df_reg %>%
  # we need only the id and occupation variables
  select(id, yrke = yrke25) %>% 
  mutate(
    # this makes a copy of the original column, that we then modify
    yrke_copy = yrke,
    yrke = str_to_lower(yrke),
    # We create a column for former, indicated by fd. We remove this from the original column.
    # we can use this later to improve the hisclass classification

    flag_fd = ifelse(str_detect(yrke, "f\\.d\\.|f\\.d|^fd| fd|f d\\.| f\\. d\\.|f\\. d$"),TRUE, FALSE),
    yrke = str_remove_all(yrke, "f\\.d\\.|f\\.d|^fd| fd|f d\\.| f\\. d\\.|f\\. d$"),
    # flag for only doing the occupation temporarily
    flag_fn = ifelse(str_detect(yrke, "f\\.n\\.|f\\. n\\.|f\\. n"),TRUE, FALSE),
    yrke = str_remove_all(yrke, "f\\.n\\.|f\\. n\\.|f\\. n"),

    # create a column for place of work
    yrke_pow = str_extract(yrke, " hos .*| vid .*| i .*| på.*| å .*| h\\. "),
    yrke = str_remove_all(yrke, " hos .*| vid .*| i .*| på.*| å .*| h\\. "),

    # create a column for former occupation
    yrke_f_occ = str_extract(yrke, " f\\..*"),
    
    # tidy up the remaining occpations
    yrke = str_remove_all(yrke, " f\\..*"),
    yrke = str_remove_all(yrke, " fa da"),
    yrke = str_remove_all(yrke, "^fa | fa$| fa "),
    yrke = str_remove_all(yrke, "^fada | fada$| fada "),
    yrke = str_remove_all(yrke, "^da | da$| da ")
  ) %>%
  mutate(flag_for_multi_occs = ifelse(str_detect(yrke_copy, "f\\.d\\.$|f\\.d$|^fd$| fd$|f d\\.$| f\\. d\\.$|f\\. d$| f\\.$"
      ) &
        str_detect(yrke_copy, " [A-Z].*"), yes = TRUE, no = FALSE
    )
  ) %>%
  mutate(
    yrke_clean = str_squish(str_remove(yrke, "f\\.d\\.$|f\\.d$|^fd$| fd$|f d\\.$| f\\. d\\.$|f\\. d$| f\\.$")),
    yrke_f_occ = case_when(
      flag_for_multi_occs == TRUE ~ word(yrke_clean, -1),
      TRUE ~ NA_character_
    ),
    yrke = case_when(
      flag_for_multi_occs == TRUE ~ str_remove(yrke, " .*"),
      TRUE ~ yrke
    )
  ) %>%
  select(-yrke_clean) %>% 
  mutate(
    # remove numbers that begin a word
    yrke = str_remove_all(yrke, "[0-9]."),
    yrke = str_remove_all(yrke, "[:punct:]"),
    yrke = str_to_lower(yrke),
    yrke = str_squish(yrke)
  ) %>%
  # tidy up funny letters
  mutate(yrke_1 = word(yrke, 1))

df_reg_25 <- df_reg_25 %>% 
  select(id, yrke_25 = yrke) 

lookup <- df_reg %>% 
  select(yrke = yrke.y, hisco_major_group_name) %>% 
  distinct()

df_reg_25 <- df_reg_25 %>% 
  left_join(lookup, by = c("yrke_25" = "yrke")) %>% 
  rename(hisco_major_group_name_25 = hisco_major_group_name)

transitions_25_30 = df_reg %>% 
  select(id, hisco_major_group_name, electricity_parish_living_in, electricity_parish_born) %>% 
  inner_join(df_reg_25, by = "id")
```

```{r}
cols <- paletteer::paletteer_d("ggsci::orange_material", n = 10) %>%
  as.character() %>% paste0() 


transitions_25_30 %>%
  count(hisco_major_group_name_25, hisco_major_group_name, electricity_parish_born) %>%
  filter(
    !is.na(hisco_major_group_name_25),
    !is.na(hisco_major_group_name)
  ) %>%
  group_by(hisco_major_group_name_25, electricity_parish_born) %>% 
  mutate(pct_share = n / sum(n)) %>% 
  ungroup() %>% 
  select(-n) %>% 
  pivot_wider(names_from = hisco_major_group_name, values_from = pct_share) %>%
  mutate(electricity_parish_born = case_when(
    electricity_parish_born == 0 ~ "Born outside electricity parish",
    TRUE ~ "Born in electricity parish"
  )) %>% 
  group_by(electricity_parish_born) %>% 
  gt() %>%
  data_color(
    columns = - hisco_major_group_name_25,
    colors  = scales::col_numeric(
      palette = cols,
      domain = NULL
    )
  ) %>% 
  tab_spanner(columns = `Professional, technical and related workers`:`Production and related workers, transport equipment operators and labourers`, label = "HISCO major group in 1930") %>% 
  cols_label(hisco_major_group_name_25 = "HISCO major group in in 1925") %>% 
  fmt_percent(columns = -hisco_major_group_name_25) %>% 
  tab_header(title = "Transition matrix by type of birth parish",
             subtitle = "Between 1925 and 1930 - percentage of HISCO major group in 1925")  %>% 
  cols_align(hisco_major_group_name_25, align = "left")
```



Map of their migrations by social class

```{r}
library(sf)
setwd(here::here())


st_map <- read_rds("data/st_map.rds") %>% 
  mutate(scbkod = as.numeric(ref_code_char)) %>% 
  st_transform(crs = 4326)
  
df_map <- st_map %>% 
  inner_join(df_reg %>%
  filter(
    electricity_parish_born == 1,
    lives_in_parish_of_birth == 0
  ) %>%
  count(scbkod))

library(leaflet)
  
bins <- c(0, 10, 20, 50, 100, 200, 500, 1000, Inf)
pal <- colorBin("viridis", domain = df_map$n, bins = bins)

labels <- sprintf(
  "<strong>%s</strong><br/>%.0f Number of people moving from electricity parishes",
  df_map$name, df_map$n
) %>% lapply(htmltools::HTML)
```


```{r}
#| column: page


leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    data = df_map,
    fillColor = ~ pal(n),
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE
    ),
    popup = labels,
  ) %>%
  addLegend("bottomright",
    pal = pal, values = df_map$n,
    title = "Number of people moving from electricity parishes"
  )

```



```{r}
# df %>%
#   filter(adult_1930 == "Adult") %>%
#   group_by(type_born, migrant) %>%
#   summarise(mean_income = round(mean(inkomst, na.rm = T))) %>%
#   ungroup() %>%
#   ggplot(aes(type_born, migrant)) +
#   geom_tile(aes(fill = mean_income)) +
#   geom_label(aes(label = mean_income)) +
#   labs(
#     title = "Mean income",
#     subtitle = "By parish of birth type",
#     x = "Parish type which individuals were born in",
#     y = "Left parish of birth?"
#   )
```

Maybe we need to think about the group that comes in 


### Checking for information in other columns

## 18 vs 15 age cutoff

```{r}
#| column: page

common_occs <- df %>% 
  filter(yrke.y != "") %>% 
  count(yrke.y, sort = T)

common_occs_small <- common_occs %>% 
  slice_max(order_by = n, n = 12) %>% 
  bind_rows(tibble(yrke.y = "Piga", n = 1))

df_age_dists <- df %>% 
  filter(yrke.y %in% common_occs_small$yrke.y)

df_age_dists %>%
  # mutate(yrke = fct_reorder(yrke, n)) %>% 
  ggplot(aes(age, fill = yrke.y)) +
  geom_density(show.legend = F) +
  geom_vline(xintercept = 15, lty = 2) +
  geom_vline(xintercept = 18, lty = 1) +
  facet_wrap(~yrke.y, scales = "free_y") +
  coord_cartesian(xlim = c(0, 75)) +
  labs(x = "Age",
       y = "Density of age by occupation",
       caption = "Note: dotted line is age 15, solid line is age 18")
```
